- name: Deploy LazyFiller Infrastructure
  hosts: all
  become: true
  gather_facts: true

  vars:
    nginx_dir: "{{ app_dir }}/nginx"
    scripts_dir: "{{ app_dir }}/scripts"
    backups_dir: "{{ app_dir }}/backups"
    file_owner: "{{ (is_development | default(false)) | ternary(omit, 'root') }}"
    file_group: "{{ (is_development | default(false)) | ternary(omit, 'root') }}"
    env_group: "{{ (is_development | default(false)) | ternary(omit, 'root') }}"

  pre_tasks:
    - name: Validate deployment target
      assert:
        that:
          - app_environment is defined
          - app_environment in ['staging', 'production', 'development']
        fail_msg: "app_environment must be 'staging', 'production', or 'development'"

    - name: Verify app directory exists
      stat:
        path: '{{ app_dir }}'
      register: app_dir_stat
      failed_when: not app_dir_stat.stat.exists

    - name: Verify Docker is running (systemd)
      systemd:
        name: docker
        state: started
      check_mode: true
      when: not is_development

    - name: Verify Docker is running (development)
      command: docker info
      changed_when: false
      when: is_development

  tasks:
    - name: Ensure directories exist
      file:
        path: '{{ item }}'
        state: directory
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: '0755'
      loop:
        - '{{ nginx_dir }}'
        - '{{ scripts_dir }}'
        - '{{ backups_dir }}'

    - name: Deploy docker-compose.yml
      template:
        src: ../templates/docker-compose.yml.j2
        dest: '{{ app_dir }}/docker-compose.yml'
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: '0644'
      register: compose_config

    - name: Deploy nginx.conf
      template:
        src: ../templates/nginx.conf.j2
        dest: '{{ nginx_dir }}/nginx.conf'
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: '0644'
      register: nginx_config

    - name: Deploy .env file
      template:
        src: ../templates/env.j2
        dest: '{{ app_dir }}/.env'
        owner: "{{ file_owner }}"
        group: "{{ env_group }}"
        mode: '0644'
      register: env_config

    - name: Deploy migration script
      template:
        src: ../templates/migrate.sh.j2
        dest: '{{ scripts_dir }}/migrate.sh'
        owner: "{{ file_owner }}"
        group: "{{ file_group }}"
        mode: '0755'

    - name: Login to GitHub Container Registry
      shell: echo '{{ vault_ghcr_token }}' | docker login ghcr.io -u '{{ vault_ghcr_username }}' --password-stdin
      no_log: true
      changed_when: false
      when: app_environment != 'development'

    - name: Pull images before deployment
      command: docker compose pull
      args:
        chdir: '{{ app_dir }}'
      register: pull_result
      changed_when: "'Pulled' in pull_result.stderr or 'Downloaded' in pull_result.stderr"
      when: app_environment != 'development'

    - name: Validate docker-compose.yml syntax
      command: docker compose -f docker-compose.yml config
      args:
        chdir: '{{ app_dir }}'
      changed_when: false
      register: compose_validation

    - name: Validate migration script syntax
      command: bash -n migrate.sh
      args:
        chdir: '{{ scripts_dir }}'
      changed_when: false
      register: script_validation

    - name: Validation summary
      debug:
        msg: |
          ✓ Docker Compose validation: PASSED
          ✓ Migration script syntax validation: PASSED

    - name: Restart containers (compose/.env changed)
      when: compose_config.changed or env_config.changed
      block:
        - name: Bring up containers
          command: docker compose up -d
          args:
            chdir: '{{ app_dir }}'
          register: compose_up

      rescue:
        - name: Capture failure state
          command: docker compose ps -a
          args:
            chdir: '{{ app_dir }}'
          register: failed_ps
          changed_when: false

        - name: Capture container logs
          command: docker compose logs --tail=30
          args:
            chdir: '{{ app_dir }}'
          register: failed_logs
          changed_when: false

        - name: Deployment failed
          fail:
            msg: |
              Deployment failed. Container status:
              {{ failed_ps.stdout }}

              Recent logs:
              {{ failed_logs.stdout }}

    - name: Validate nginx config (nginx change)
      when: nginx_config.changed
      command: docker compose run --rm -T --no-deps nginx nginx -t
      args:
        chdir: '{{ app_dir }}'
      changed_when: false

    - name: Restart nginx (nginx change)
      when: nginx_config.changed
      command: docker compose restart nginx
      args:
        chdir: '{{ app_dir }}'

  post_tasks:
    - name: Verify deployment
      command: docker compose ps --format json
      args:
        chdir: '{{ app_dir }}'
      register: final_status
      changed_when: false

    - name: Deployment summary
      debug:
        msg: |
          ✓ Deployed to {{ app_environment }}
          ✓ Location: {{ app_dir }}
